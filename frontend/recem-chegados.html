<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Encantaria — Recém-Chegados</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .side-menu a { display:block; margin:6px 0; color:#222; text-decoration:none; }
    .side-menu a.active { font-weight:700; color:var(--accent); }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">Encantaria</div>
    <nav class="nav">
      <a href="index.html">home</a>
      <a href="sobre.html">sobre nós</a>
      <a href="cadastro.html">cadastro</a>
      <a href="login.html">login</a>
    </nav>
  </header>

  <aside class="side-menu">
    <strong>Categorias</strong>
    <a href="#" data-cat="Geral" class="active">Geral</a>
    <a href="#" data-cat="Música">Música</a>
    <a href="#" data-cat="Dança">Dança</a>
    <a href="#" data-cat="Teatro">Teatro</a>
    <a href="#" data-cat="Circo">Circo</a>
    <a href="#" data-cat="Pintura">Pintura / Artes Visuais</a>
    <a href="#" data-cat="Fotografia">Fotografia</a>
    <a href="#" data-cat="Literatura">Literatura</a>
    <a href="#" data-cat="Artesanato">Artesanato</a>
    <a href="#" data-cat="Cinema">Cinema & Vídeo</a>
    <a href="#" data-cat="Moda">Moda</a>
    <a href="#" data-cat="Eventos">Produção de Eventos</a>
    <a href="#" data-cat="Outros">Outros</a>
  </aside>

  <main class="container">
    <div class="top-bar">
      <h3>Recém-Chegados ✨</h3>
      <a href="criar-anuncio.html" class="btn" style="background-color:var(--accent);">+ Publicar Talento</a>
    </div>

    <div class="listings" id="anuncios">
      </div>
  </main>

  <script>
    let anunciosCache = null;

    function norm(str) {
      return (str || '').toString().trim().toLowerCase();
    }

    async function carregarAnuncios(categoria = 'Geral') {
      const wrap = document.getElementById('anuncios');
      wrap.innerHTML = '<p>Carregando...</p>';

      try {
        if (!anunciosCache) {
          const res = await fetch('/anuncios');
          if (!res.ok) throw new Error('Erro ao buscar anúncios');
          anunciosCache = await res.json();
        }

        // Filtra se a categoria não for 'geral'
        const resultados = (categoria && norm(categoria) !== 'geral')
          ? anunciosCache.filter(a => {
              // Comparação flexível para pegar "Pintura" dentro de "Pintura / Artes Visuais"
              const catItem = norm(a.categoria);
              const catFiltro = norm(categoria).split(' ')[0]; // Pega a primeira palavra chave
              return catItem.includes(catFiltro) || catFiltro.includes(catItem);
            })
          : anunciosCache;

        wrap.innerHTML = '';
        if (!resultados.length) {
          wrap.innerHTML = `<p>Nenhum talento encontrado em "<strong>${categoria}</strong>".</p>`;
          return;
        }

        resultados.forEach(a => {
          const div = document.createElement('div');
          div.className = 'listing';

          const img = document.createElement('img');
          // Gera uma imagem consistente baseada no ID
          const seed = a.id ?? Math.floor(Math.random()*10000);
          img.src = `https://picsum.photos/seed/encantaria${seed}/400/240`;
          div.appendChild(img);

          const title = document.createElement('div');
          title.innerHTML = `<strong>${a.titulo}</strong>`;
          div.appendChild(title);

          const cat = document.createElement('div');
          cat.style.fontSize = '13px';
          cat.style.color = '#666';
          cat.innerText = a.categoria;
          div.appendChild(cat);

          const btn = document.createElement('a');
          btn.className = 'btn';
          btn.style.marginTop='8px';
          btn.href = `detalhes.html?id=${a.id}`;
          btn.innerText = 'Saiba mais';
          div.appendChild(btn);

          wrap.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        wrap.innerHTML = '<p>Erro ao carregar. Verifique o console.</p>';
      }
    }

    document.querySelectorAll('.side-menu a[data-cat]').forEach(link => {
      link.addEventListener('click', (ev) => {
        ev.preventDefault();
        document.querySelectorAll('.side-menu a').forEach(a => a.classList.remove('active'));
        link.classList.add('active');
        carregarAnuncios(link.getAttribute('data-cat'));
      });
    });

    carregarAnuncios('Geral');
  </script>
</body>
</html>